<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Connexion MetaMask Fiable</title>
  <style> body { font-family: Arial; text-align: center; margin-top: 100px; } button { padding: 12px 24px; font-size: 16px; cursor: pointer; } #status { margin-top: 20px; font-weight: bold; } </style>
</head>
<body>
  <h1>Connecter MetaMask</h1>
  <button id="btn">ü¶ä Connecter</button>
  <div id="status"></div>

  <script>
    const btn = document.getElementById("btn");
    const status = document.getElementById("status");

    btn.addEventListener("click", async () => {
      status.textContent = "";
      if (typeof window.ethereum === "undefined") {
        status.textContent = "‚ùå MetaMask non d√©tect√©.";
        console.log("window.ethereum est undefined");
        return;
      }

      try {
        const accounts = await window.ethereum.request({ method: "eth_requestAccounts" });
        status.style.color = "green";
        status.textContent = "‚úÖ Connect√© √† : " + accounts[0];
        console.log("Accounts:", accounts);
      } catch (err) {
        console.error("eth_requestAccounts erreur:", err);
        if (err.code === -32002 || err.message.includes("Already processing")) {
          // fallback avec perm request
          try {
            const perms = await window.ethereum.request({
              method: "wallet_requestPermissions",
              params: [{ eth_accounts: {} }]
            });
            const account = perms[0]?.caveats?.[0]?.value[0];
            if (account) {
              status.style.color = "green";
              status.textContent = "‚úÖ Connect√© (via permissions) : " + account;
              console.log("Permissions:", perms);
              return;
            }
          } catch (permErr) {
            console.error("wallet_requestPermissions erreur:", permErr);
          }
        }
        if (err.code === 4001) {
          status.textContent = "‚ùå Connexion refus√©e.";
        } else {
          status.textContent = "‚ùå Erreur inconnue, voir console.";
        }
      }
    });
  </script>
</body>
</html>
